---
layout: post
title: JavaScript中正则表达式的工作原理和优化
category: JavaScript
description: 正则表达式的优化是一个相当广泛和细致入微的话题。粗浅地编写正则表达式是造成性能瓶颈的主要原因，有很多可以改进正则表达式效率的地方。两个正则表达式匹配相同的文本并不意味着他们具有同等的速度。
keywords: JavaScript,正则表达式,高性能,优化,笔记
---

##1.前言

正则表达式的优化是一个相当广泛和细致入微的话题。粗浅地编写正则表达式是造成性能瓶颈的主要原因，有很多可以改进正则表达式效率的地方。两个正则表达式匹配相同的文本并不意味着他们具有同等的速度。

##2.正则表达式工作原理

一个正则表达式处理的基本步骤：

__第一步：编译__  

当创建了一个正则表达式对象之后（使用一个正则表达式直接量或者 RegExp 构造器），浏览器检查你的模板有没有错误，然后开始执行匹配工作。如果你将正则表达式赋给一个变量，你可以避免重复执行此步骤。

__第二步：设置起始位置__ 

当一个正则表达式投入使用时，目标字符串从起始位置开始匹配，或者由正则表达式的 lastIndex 属性指定。当执行到第四步执行失败后，回到上次起始位置的后面一个字符上开始匹配。

__第三步：匹配每个正则表达式的字元__  

正则表达式一旦找好起始位置，它将一个一个地扫描目标文本和正则表达式模板。当一个特定字元匹配失败时，正则表达式将试图回溯到扫描之前的位置上，然后进入正则表达式其他可能的路径上。

__第四步：匹配成功或失败__  

如果在字符串的当前位置上发现一个完全匹配，那么正则表达式宣布成功。如果正则表达式的所有可能路径都尝试过了，但是没有成功地匹配，那么正则表达式引擎回到第二步，从字符串的下一个字符重新尝试。只有字符串中的每个字符（以及最后一个字符后面的位置）都经历了这样的过程之后，还没有成功匹配，那么正则表达式就宣布彻底失败。

##3.正则表达式的回溯

正则表达式对目标字符串从左到右依次扫面，在每个字符的位置上是否匹配。对于每一个量词和分支，都必须决定如何继续进行。如果是一个量词（诸如*， +?，或者{2,}），正则表达式必须决定何时尝试匹配更多的字符；如果遇到分支（通过|操作符），它必须从这些选项中选择一个进行尝试。

正则表达式对于每一个量词和分支的匹配，会选择一个方案，然后记住其他选项返回备用。当所选方案匹配成功，继续扫描，如果其他部分的匹配也成功，则匹配结束。而如果所选方案匹配失败，或者其他部分的匹配失败，正则表达式会回溯到上一个选择点，选择其他方案执行上面的过程匹配，如果量词和分支的所有排列组合都匹配失败了，就放弃该位置的匹配，到该位置的下一个字符上重复此过程。

*分支结构的栗子*：

```JavaScript
/h(ello|appy) hippo/.test("hello there, happy hippo");
```

匹配过程：

该正则表达式匹配“hello hippo”或“happy hippo”。  
首先查找字符"h"，目标字符串的第一个字符就是h。  
接下来有一个分支结构(ello|appy)，它提供了两个选项，正则表达式先选择最左边的"ello"匹配，发现匹配。  
接下来匹配空格，成功。  
下面匹配"h"，不能匹配接下来的字符t，匹配失败。  
回溯到上一个检查点（匹配首字符h的下一个字符），匹配下一个分支选项"appy"，匹配失败。  
由于没有更多选项，从第二个字符开始重新匹配该字符串。  
由于没有找到h继续找到，知道找到第14个字符找到，匹配到h。  
接下来匹配分支结构，和上面的过程一个，"ello"匹配失败，回溯到分支过程开始匹配"appy"。  
下面匹配"hippo"，匹配成功结束。


*量词结构的栗子：*

```JavaScript
var str = "<p>Para 1.</p><img src='smiley.jpg'><p>Para 2.</p><div>Div.</div>"
/<p>.*<\/p>/i.test(str)
```

匹配过程：

首先开始匹配了字符串开始三个字符`<p>`。  
接下来匹配".*"。`.`匹配除换行符以外的任意字符，`*`是一个贪婪量词，表示重复零次或多次，并且匹配尽量多的次数。因为目标字符串中没有换行符，它将吞噬
剩下的全部字符串！  
接下来正则表达式从字符串末尾来时匹配`<`，匹配最后一个字符失败，回溯上一个字符继续匹配，直到回到`</div>`的`<`位置。  
然后匹配反斜杠`/`。成功。  
然后匹配p，失败。  
继续回溯，重复上面的过程，直到匹配了`</p>`，成功。



